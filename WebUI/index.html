<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/leaflet.css">
    <script src="js/leaflet.js"></script>
    <link href="css/stylesheet.css" rel="stylesheet">
</head>
<body>
    <div id="mySidenav" class="sidenav">
        <table style="color: black; width: 100%; padding-right: 20px">
            <tr>
                <th style="text-align: left; padding-left: 20px; width: 100%;">
                    <h2>Configuration</h2>
                </th>
                <th>
                    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()"><img src="icons/cancel.png" width=20/></a>
                </th>
            </tr>
        </table>
        <div id="selections">
            <h3>Select Country</h3>
            <form>
              <select id="country" name="country">
              </select>
            </form>
            <h3>Select Year</h3>
            <form>
              <select id="year" name="year">
              </select>
            </form>
            <h3>Select Category</h3>
            <form>
              <select id="category" name="category">
                  <option value="Crop Land">Crop Land</option>
                  <option value="Fish">Fish</option>
                  <option value="Forest">Forest</option>
                  <option value="Grazing">Grazing</option>
                  <option value="Carbon">Carbon</option>
              </select>
            </form>
            <br>
            <button id="btnSimulate">Simulate</button>
            <button>Reset</button>            
        </div>
    </div>
    <div id=header>
        <table style="color: white; width: 100%;">
            <tr>
                <th style="text-align: left; padding-left: 20px; width: 100%"><h2>Ecological Footprint Simulator</h2></th>
                <th><span style="text-align: right;font-size:30px;cursor:pointer;padding-right: 15px" onclick="openNav()">Configuration</span></th>
            </tr>
        </table>
    </div>
    <div id="mapid"></div>
    <script src="js/navbar.js"></script>
    <script src="js/initmap.js"></script>
    <script>
        let countryMap = {}
        let dropdownCountries = document.getElementById("country");
        let btnSimulate = document.getElementById("btnSimulate");
        let dropdownYears = document.getElementById("year");
        let countryName, year = "";

        btnSimulate.addEventListener("click", senPredictionRequest);

        function senPredictionRequest(){
            countryName = getSelectedOption(dropdownCountries);
            year = getSelectedOption(dropdownYears);
            let url = "http://127.0.0.1:5000/predict/COUNTRY_HOLDER/YEAR_HOLDER";
            url = url.replace("COUNTRY_HOLDER", countryName).replace("YEAR_HOLDER", year);
            sendRequest("GET", url, "", "json", createMarker);
        }

        function createMarker(response){
            let marker = L.marker([countryMap.get(countryName).Latitude,
            countryMap.get(countryName).Longitude]).addTo(mymap);

            let markerCountry = `<b>Selected Country:</b> ${countryName}<br>`;
            let markerYear = `<b>In Year: </b> ${year}<br>`;
            let markerPopulation = `<b>Population:</b> ${response["Population"]}<br>`;
            let markerCropland = `<b>Cropland Consumption:</b> ${response["Cropland Footprint"]}<br>`;
            let markerGrazing = `<b>Grazing Land Consumption:</b> ${response["Grazing Footprint"]}<br>`;
            let markerForest = `<b>Forest Land Consumption:</b> ${response["Forest Footprint"]}<br>`;
            let markerCarbon = `<b>Carbon Consumption:</b> ${response["Carbon Footprint"]}<br>`;
            let markerFish = `<b>Fish Consumption:</b> ${response["Fish Footprint"]}<br>`;
            
            let markerData = markerCountry + markerYear + markerPopulation + markerCropland 
            + markerGrazing + markerForest + markerCarbon + markerFish;
            marker.bindPopup(markerData).openPopup();
        }

        function getSelectedOption(selectElement){
            return selectElement.options[selectElement.selectedIndex].value;
        }

        function sendRequest(requestType, url, parameters, responseType, callback){
            let request = new XMLHttpRequest();
            request.responseType = responseType
            request.addEventListener("readystatechange", function(){
                //For pre-defined ready state constants,
                //refer to: https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/readyState 
                if(request.readyState == 4 && request.status == 200){
                   callback(request.response);
                }
            });
            request.open(requestType, (url+parameters), true);
            request.send(null);
        }

        function populateCountryDropdown(countries){
            countryMap = new Map(Object.entries(countries));
            for(let key of countryMap.keys()){
                dropdownCountries.appendChild(createNewChild("option", key, key));
            }
        }

        function populateYearDropdown(){
            for(let index=2000; index<=2015; index++){
                dropdownYears.appendChild(createNewChild("option", index, index));
            }
        }

        function createNewChild(elementType, text, value){
            let newElement = document.createElement("option");
            newElement.setAttribute("value", value);
            newElement.text = text;

            return newElement;
        }

        sendRequest("GET", "http://127.0.0.1:5000/countries", "", "json", populateCountryDropdown);
        populateYearDropdown();

    </script>
</body>
</html>